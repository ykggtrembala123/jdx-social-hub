# ü§ñ Guia de Integra√ß√£o - Bot Discord

## üìã Informa√ß√µes Essenciais

### Credenciais Supabase
```javascript
const SUPABASE_URL = 'https://oyoifasethtkfkocppzs.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im95b2lmYXNldGh0a2Zrb2NwcHpzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NjAxMTYsImV4cCI6MjA3NTIzNjExNn0.mu7kO3i-H4eTjM9omkOPgRz0zJTqDP5n_9Pmxmzimiw';
```

### URL do Site
```
https://seu-projeto.lovable.app
```

---

## üéØ Comandos do Bot

### 1. `/meus-ganhos` - Ver Estat√≠sticas Pessoais

**Descri√ß√£o**: Mostra os ganhos e estat√≠sticas do afiliado

**C√≥digo Completo**:
```javascript
// Comando para ver ganhos do afiliado
client.on('interactionCreate', async (interaction) => {
  if (!interaction.isCommand()) return;
  
  if (interaction.commandName === 'meus-ganhos') {
    try {
      const discordId = interaction.user.id;
      
      // Chama a edge function
      const response = await fetch(`${SUPABASE_URL}/functions/v1/get-affiliate-by-discord-id`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
        },
        body: JSON.stringify({ discordUserId: discordId })
      });
      
      if (!response.ok) {
        throw new Error('Afiliado n√£o encontrado');
      }
      
      const data = await response.json();
      
      // Cria embed com as informa√ß√µes
      const embed = new EmbedBuilder()
        .setColor('#00D9FF')
        .setTitle(`üí∞ Ganhos de ${data.name}`)
        .setDescription(`**C√≥digo**: ${data.code} | **Tier**: ${getTierEmoji(data.tier)} ${data.tier.toUpperCase()}`)
        .addFields(
          { name: 'üíµ Total de Ganhos', value: `R$ ${data.total_earnings.toFixed(2)}`, inline: true },
          { name: '‚è≥ Ganhos Pendentes', value: `R$ ${(data.pending_earnings || 0).toFixed(2)}`, inline: true },
          { name: 'üíé Ganhos em Cascata', value: `R$ ${(data.total_cascade_earnings || 0).toFixed(2)}`, inline: true },
          { name: 'üìä Total de Leads', value: `${data.total_leads}`, inline: true },
          { name: '‚úÖ Total de Vendas', value: `${data.total_sales}`, inline: true },
          { name: 'üéØ Comiss√£o', value: `${data.commission}%`, inline: true },
          { name: 'üë• Sub-Afiliados', value: `${data.sub_affiliates_count || 0}`, inline: true }
        )
        .setFooter({ text: `Acesse seu dashboard completo em: ${SITE_URL}/auth` })
        .setTimestamp();
      
      await interaction.reply({ embeds: [embed], ephemeral: true });
      
    } catch (error) {
      console.error('Erro ao buscar ganhos:', error);
      await interaction.reply({ 
        content: '‚ùå Erro ao buscar seus ganhos. Voc√™ est√° cadastrado como afiliado?', 
        ephemeral: true 
      });
    }
  }
});

// Fun√ß√£o auxiliar para emojis de tier
function getTierEmoji(tier) {
  const emojis = {
    'bronze': 'ü•â',
    'prata': 'ü•à',
    'ouro': 'ü•á',
    'diamante': 'üíé'
  };
  return emojis[tier] || 'ü•à';
}
```

---

### 2. `/criar-lead` - Criar Novo Lead (Admin)

**Descri√ß√£o**: Cria um novo lead no sistema

**Par√¢metros**:
- `codigo_afiliado` (string): C√≥digo do afiliado (ex: AFF001)
- `ticket_id` (string): ID do ticket
- `valor` (number): Valor da transa√ß√£o
- `cliente` (string): Nome do cliente (opcional)

**C√≥digo Completo**:
```javascript
client.on('interactionCreate', async (interaction) => {
  if (!interaction.isCommand()) return;
  
  if (interaction.commandName === 'criar-lead') {
    try {
      // Verifica se √© admin
      const isAdmin = await checkIfAdmin(interaction.user.id);
      if (!isAdmin) {
        return interaction.reply({ 
          content: '‚ùå Apenas administradores podem criar leads.', 
          ephemeral: true 
        });
      }
      
      const affiliateCode = interaction.options.getString('codigo_afiliado');
      const ticketId = interaction.options.getString('ticket_id');
      const value = interaction.options.getNumber('valor');
      const clientName = interaction.options.getString('cliente') || 'Cliente';
      
      // Chama a edge function
      const response = await fetch(`${SUPABASE_URL}/functions/v1/create-lead`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
        },
        body: JSON.stringify({
          affiliate_code: affiliateCode,
          ticket_id: ticketId,
          transaction_value: value,
          client_name: clientName
        })
      });
      
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Erro ao criar lead');
      }
      
      const data = await response.json();
      
      const embed = new EmbedBuilder()
        .setColor('#00FF00')
        .setTitle('‚úÖ Lead Criado com Sucesso!')
        .addFields(
          { name: 'üé´ Ticket ID', value: ticketId, inline: true },
          { name: 'üë§ Afiliado', value: affiliateCode, inline: true },
          { name: 'üíµ Valor', value: `R$ ${value.toFixed(2)}`, inline: true },
          { name: 'üßë Cliente', value: clientName, inline: true },
          { name: 'üí∞ Comiss√£o', value: `R$ ${data.lead.affiliate_commission.toFixed(2)}`, inline: true },
          { name: 'üìä Status', value: '‚è≥ Pendente', inline: true }
        )
        .setTimestamp();
      
      await interaction.reply({ embeds: [embed] });
      
    } catch (error) {
      console.error('Erro ao criar lead:', error);
      await interaction.reply({ 
        content: `‚ùå Erro ao criar lead: ${error.message}`, 
        ephemeral: true 
      });
    }
  }
});

// Fun√ß√£o para verificar se √© admin
async function checkIfAdmin(discordId) {
  try {
    const response = await fetch(`${SUPABASE_URL}/functions/v1/check-admin`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
      },
      body: JSON.stringify({ discordId })
    });
    
    const data = await response.json();
    return data.isAdmin || false;
  } catch {
    return false;
  }
}
```

---

### 3. `/confirmar-venda` - Confirmar Venda (Admin)

**Descri√ß√£o**: Confirma uma venda e credita comiss√µes

**Par√¢metros**:
- `ticket_id` (string): ID do ticket a confirmar

**C√≥digo Completo**:
```javascript
client.on('interactionCreate', async (interaction) => {
  if (!interaction.isCommand()) return;
  
  if (interaction.commandName === 'confirmar-venda') {
    try {
      // Verifica se √© admin
      const isAdmin = await checkIfAdmin(interaction.user.id);
      if (!isAdmin) {
        return interaction.reply({ 
          content: '‚ùå Apenas administradores podem confirmar vendas.', 
          ephemeral: true 
        });
      }
      
      const ticketId = interaction.options.getString('ticket_id');
      
      // Chama a edge function
      const response = await fetch(`${SUPABASE_URL}/functions/v1/confirm-sale`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
        },
        body: JSON.stringify({ ticket_id: ticketId })
      });
      
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Erro ao confirmar venda');
      }
      
      const data = await response.json();
      
      const embed = new EmbedBuilder()
        .setColor('#00FF00')
        .setTitle('‚úÖ Venda Confirmada!')
        .setDescription(`A venda do ticket **${ticketId}** foi confirmada com sucesso.`)
        .addFields(
          { name: 'üí∞ Comiss√µes Creditadas', value: 'As comiss√µes foram automaticamente creditadas aos afiliados.' }
        )
        .setTimestamp();
      
      await interaction.reply({ embeds: [embed] });
      
    } catch (error) {
      console.error('Erro ao confirmar venda:', error);
      await interaction.reply({ 
        content: `‚ùå Erro ao confirmar venda: ${error.message}`, 
        ephemeral: true 
      });
    }
  }
});
```

---

### 4. `/solicitar-saque` - Solicitar Saque

**Descri√ß√£o**: Afiliado solicita um saque

**Par√¢metros**:
- `valor` (number): Valor do saque
- `metodo` (string): M√©todo de pagamento (PIX, TED, etc)
- `chave_pix` (string): Chave PIX ou dados banc√°rios

**C√≥digo Completo**:
```javascript
client.on('interactionCreate', async (interaction) => {
  if (!interaction.isCommand()) return;
  
  if (interaction.commandName === 'solicitar-saque') {
    try {
      const discordId = interaction.user.id;
      
      // Busca dados do afiliado
      const affiliateResponse = await fetch(`${SUPABASE_URL}/functions/v1/get-affiliate-by-discord-id`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
        },
        body: JSON.stringify({ discordUserId: discordId })
      });
      
      if (!affiliateResponse.ok) {
        throw new Error('Afiliado n√£o encontrado');
      }
      
      const affiliate = await affiliateResponse.json();
      
      const amount = interaction.options.getNumber('valor');
      const method = interaction.options.getString('metodo');
      const paymentAddress = interaction.options.getString('chave_pix');
      
      // Valida saldo
      if (amount > affiliate.total_earnings) {
        return interaction.reply({
          content: `‚ùå Saldo insuficiente. Voc√™ tem R$ ${affiliate.total_earnings.toFixed(2)} dispon√≠vel.`,
          ephemeral: true
        });
      }
      
      // Cria solicita√ß√£o de saque
      const response = await fetch(`${SUPABASE_URL}/functions/v1/request-withdrawal`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
        },
        body: JSON.stringify({
          affiliate_code: affiliate.code,
          amount: amount,
          payment_method: method,
          payment_address: paymentAddress
        })
      });
      
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Erro ao solicitar saque');
      }
      
      const embed = new EmbedBuilder()
        .setColor('#FFD700')
        .setTitle('üí∞ Solicita√ß√£o de Saque Enviada')
        .setDescription('Sua solicita√ß√£o foi enviada e ser√° analisada em breve.')
        .addFields(
          { name: 'üíµ Valor', value: `R$ ${amount.toFixed(2)}`, inline: true },
          { name: 'üè¶ M√©todo', value: method, inline: true },
          { name: 'üîë Chave/Dados', value: paymentAddress, inline: false },
          { name: 'üìä Status', value: '‚è≥ Pendente', inline: true }
        )
        .setFooter({ text: 'Voc√™ receber√° uma notifica√ß√£o quando o saque for processado.' })
        .setTimestamp();
      
      await interaction.reply({ embeds: [embed], ephemeral: true });
      
    } catch (error) {
      console.error('Erro ao solicitar saque:', error);
      await interaction.reply({ 
        content: `‚ùå Erro ao solicitar saque: ${error.message}`, 
        ephemeral: true 
      });
    }
  }
});
```

---

### 5. `/afiliado-info` - Ver Info de Afiliado (Admin)

**Descri√ß√£o**: Admin visualiza informa√ß√µes de qualquer afiliado

**Par√¢metros**:
- `codigo` (string): C√≥digo do afiliado

**C√≥digo Completo**:
```javascript
client.on('interactionCreate', async (interaction) => {
  if (!interaction.isCommand()) return;
  
  if (interaction.commandName === 'afiliado-info') {
    try {
      // Verifica se √© admin
      const isAdmin = await checkIfAdmin(interaction.user.id);
      if (!isAdmin) {
        return interaction.reply({ 
          content: '‚ùå Apenas administradores podem ver informa√ß√µes de afiliados.', 
          ephemeral: true 
        });
      }
      
      const code = interaction.options.getString('codigo');
      
      // Chama a edge function
      const response = await fetch(`${SUPABASE_URL}/functions/v1/get-affiliate`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
        },
        body: JSON.stringify({ code })
      });
      
      if (!response.ok) {
        throw new Error('Afiliado n√£o encontrado');
      }
      
      const data = await response.json();
      
      const embed = new EmbedBuilder()
        .setColor('#00D9FF')
        .setTitle(`üìä Informa√ß√µes - ${data.name}`)
        .addFields(
          { name: 'üîñ C√≥digo', value: data.code, inline: true },
          { name: 'üé≠ Discord ID', value: data.discord_user_id, inline: true },
          { name: 'üèÜ Tier', value: `${getTierEmoji(data.tier)} ${data.tier.toUpperCase()}`, inline: true },
          { name: 'üíµ Total Ganho', value: `R$ ${data.total_earnings.toFixed(2)}`, inline: true },
          { name: '‚è≥ Pendente', value: `R$ ${(data.pending_earnings || 0).toFixed(2)}`, inline: true },
          { name: 'üíé Cascata', value: `R$ ${(data.total_cascade_earnings || 0).toFixed(2)}`, inline: true },
          { name: 'üìä Leads', value: `${data.total_leads}`, inline: true },
          { name: '‚úÖ Vendas', value: `${data.total_sales}`, inline: true },
          { name: 'üéØ Comiss√£o', value: `${data.commission}%`, inline: true },
          { name: 'üë• Sub-Afiliados', value: `${data.sub_affiliates_count || 0}`, inline: true },
          { name: 'üë§ Indicado por', value: data.referred_by || 'Nenhum', inline: true }
        )
        .setTimestamp();
      
      await interaction.reply({ embeds: [embed] });
      
    } catch (error) {
      console.error('Erro ao buscar afiliado:', error);
      await interaction.reply({ 
        content: `‚ùå Erro: ${error.message}`, 
        ephemeral: true 
      });
    }
  }
});
```

---

## üìù Registro de Comandos

**Adicione isso ao seu arquivo de deploy de comandos**:

```javascript
const commands = [
  {
    name: 'meus-ganhos',
    description: 'Ver suas estat√≠sticas e ganhos como afiliado'
  },
  {
    name: 'criar-lead',
    description: '[ADMIN] Criar um novo lead',
    options: [
      {
        name: 'codigo_afiliado',
        type: 3, // STRING
        description: 'C√≥digo do afiliado (ex: AFF001)',
        required: true
      },
      {
        name: 'ticket_id',
        type: 3, // STRING
        description: 'ID do ticket',
        required: true
      },
      {
        name: 'valor',
        type: 10, // NUMBER
        description: 'Valor da transa√ß√£o',
        required: true
      },
      {
        name: 'cliente',
        type: 3, // STRING
        description: 'Nome do cliente',
        required: false
      }
    ]
  },
  {
    name: 'confirmar-venda',
    description: '[ADMIN] Confirmar uma venda e creditar comiss√µes',
    options: [
      {
        name: 'ticket_id',
        type: 3, // STRING
        description: 'ID do ticket a confirmar',
        required: true
      }
    ]
  },
  {
    name: 'solicitar-saque',
    description: 'Solicitar um saque dos seus ganhos',
    options: [
      {
        name: 'valor',
        type: 10, // NUMBER
        description: 'Valor do saque',
        required: true
      },
      {
        name: 'metodo',
        type: 3, // STRING
        description: 'M√©todo de pagamento (PIX, TED, etc)',
        required: true
      },
      {
        name: 'chave_pix',
        type: 3, // STRING
        description: 'Chave PIX ou dados banc√°rios',
        required: true
      }
    ]
  },
  {
    name: 'afiliado-info',
    description: '[ADMIN] Ver informa√ß√µes de um afiliado',
    options: [
      {
        name: 'codigo',
        type: 3, // STRING
        description: 'C√≥digo do afiliado',
        required: true
      }
    ]
  }
];

// Registrar comandos
const rest = new REST({ version: '10' }).setToken(process.env.DISCORD_TOKEN);

(async () => {
  try {
    console.log('Registrando comandos...');
    await rest.put(
      Routes.applicationCommands(process.env.CLIENT_ID),
      { body: commands }
    );
    console.log('‚úÖ Comandos registrados com sucesso!');
  } catch (error) {
    console.error(error);
  }
})();
```

---

## üîß Configura√ß√£o do .env

```env
DISCORD_TOKEN=seu_token_do_bot
CLIENT_ID=seu_client_id
SUPABASE_URL=https://oyoifasethtkfkocppzs.supabase.co
SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im95b2lmYXNldGh0a2Zrb2NwcHpzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NjAxMTYsImV4cCI6MjA3NTIzNjExNn0.mu7kO3i-H4eTjM9omkOPgRz0zJTqDP5n_9Pmxmzimiw
SITE_URL=https://seu-projeto.lovable.app
```

---

## ‚úÖ Checklist de Implementa√ß√£o

- [ ] Configurar credenciais Supabase no .env
- [ ] Registrar todos os comandos do bot
- [ ] Implementar `/meus-ganhos`
- [ ] Implementar `/criar-lead`
- [ ] Implementar `/confirmar-venda`
- [ ] Implementar `/solicitar-saque`
- [ ] Implementar `/afiliado-info`
- [ ] Testar cada comando individualmente
- [ ] Adicionar tratamento de erros
- [ ] Configurar mensagens de sucesso/erro

---

## üéØ Pr√≥ximos Passos

1. Copie todos os c√≥digos acima
2. Configure o .env com suas credenciais
3. Registre os comandos
4. Teste cada comando
5. Ajuste mensagens conforme necess√°rio

**Bot pronto para integra√ß√£o! üöÄ**
